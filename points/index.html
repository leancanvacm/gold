<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Check-in</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Font -->
    <link href="https://cdn.jsdelivr.net/gh/maketline/goodday/font/stylesheet.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'line_seed_sans_th', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Animation for loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="main-content" class="hidden">
        
        <!-- User Profile Header -->
        <header class="bg-white p-4 shadow-md sticky top-0 z-10">
            <div class="container mx-auto flex items-center space-x-4">
                <img id="user-picture" src="https://placehold.co/100x100" class="w-16 h-16 rounded-full border-2 border-blue-200">
                <div>
                    <h1 id="user-name" class="font-bold text-lg">...</h1>
                    <div class="flex items-center space-x-2 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <span id="user-points" class="font-bold text-xl text-blue-600">0</span>
                        <span class="text-gray-600">คะแนน</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-white border-b-2 border-gray-200">
            <div class="container mx-auto flex">
                <button onclick="switchTab('checkin')" class="tab-button flex-1 p-4 font-semibold border-b-4 border-transparent transition active">เช็คอิน</button>
                <button onclick="switchTab('redeem')" class="tab-button flex-1 p-4 font-semibold border-b-4 border-transparent transition">แลกรางวัล</button>
                <button id="admin-tab-button" onclick="switchTab('admin')" class="tab-button flex-1 p-4 font-semibold border-b-4 border-transparent transition hidden">แอดมิน</button>
            </div>
        </nav>

        <!-- Main Container -->
        <main class="container mx-auto p-4">
            
            <!-- Check-in Tab -->
            <div id="checkin-tab" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                    <h2 class="text-2xl font-bold mb-2">เช็คอินรายวัน</h2>
                    <p class="text-gray-600 mb-4">เช็คอินทุกวันเพื่อรับคะแนนสะสม!</p>
                    <p class="mb-4">
                        <span class="font-semibold">เช็คอินต่อเนื่อง: </span>
                        <span id="consecutive-days" class="font-bold text-blue-600">0</span> วัน
                    </p>
                    <button id="checkin-button" onclick="handleCheckIn()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-lg text-lg transition shadow-lg hover:shadow-xl disabled:bg-gray-400 disabled:cursor-not-allowed">
                        เช็คอินเลย!
                    </button>
                    <p id="checkin-message" class="mt-4 text-green-600 font-semibold"></p>
                    
                    <div class="mt-6 text-left text-sm text-gray-500 bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-bold mb-2">เงื่อนไขการรับคะแนน:</h4>
                        <ul class="list-disc list-inside">
                            <li>เช็คอินปกติ รับ <span class="font-bold">0.5</span> คะแนน</li>
                            <li>เช็คอินต่อเนื่องครบ <span class="font-bold">7</span> วัน รับโบนัส <span class="font-bold">1</span> คะแนนในวันที่ 7</li>
                            <li>หากขาดการเช็คอิน การนับวันต่อเนื่องจะเริ่มต้นใหม่</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Redeem Tab -->
            <div id="redeem-tab" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">แลกของรางวัล</h2>
                <div id="rewards-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Reward cards will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="admin-tab" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">จัดการคำขอแลกรางวัล</h2>
                <div id="admin-list" class="space-y-4">
                    <!-- Pending redemption items will be inserted here -->
                </div>
            </div>
        </main>
    </div>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/versions/2.21.0/sdk.js"></script>

    <!-- Main Application Logic -->
    <script>
        // --- [!] CONFIGURATION [!] ---
        const LIFF_ID = '1656032875-GLpZe6By'; // ใส่ LIFF ID ของคุณ
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxmTQ0knrfzI2puvfueSrjlTFKjA7KzG9aj1H356zyyUAwiCrP0HxkROceSsOVSdNgPHg/exec'; // ใส่ URL ของ Web App ที่ได้จาก Google Apps Script

        let myUid = '';
        let myPoints = 0;

        // --- [1] INITIALIZATION ---
        window.onload = async () => {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                myUid = profile.userId;
                document.getElementById('user-picture').src = profile.pictureUrl;
                document.getElementById('user-name').textContent = profile.displayName;

                // Fetch initial user data
                jsonpRequest({
                    action: 'getUserData',
                    uid: myUid,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                }, handleUserDataResponse);

            } catch (error) {
                console.error('LIFF Initialization failed', error);
                alert('เกิดข้อผิดพลาดในการเปิดแอป');
            }
        };

        // --- [2] JSONP REQUEST HANDLER ---
        function jsonpRequest(params, callback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = (data) => {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };

            const script = document.createElement('script');
            params.callback = callbackName;
            const queryString = Object.keys(params).map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join('&');
            script.src = `${GAS_URL}?${queryString}`;
            document.body.appendChild(script);
        }

        // --- [3] DATA RESPONSE HANDLERS ---

        // Handle initial user data
        function handleUserDataResponse(data) {
            if (data.success) {
                myPoints = data.points;
                document.getElementById('user-points').textContent = data.points.toFixed(1);
                document.getElementById('consecutive-days').textContent = data.consecutive;
                
                if (data.canCheckIn) {
                    document.getElementById('checkin-button').disabled = false;
                    document.getElementById('checkin-message').textContent = '';
                } else {
                    document.getElementById('checkin-button').disabled = true;
                    document.getElementById('checkin-button').textContent = 'เช็คอินแล้ววันนี้';
                    document.getElementById('checkin-message').textContent = `เช็คอินครั้งถัดไปได้ในวันพรุ่งนี้`;
                }

                if (data.isAdmin) {
                    document.getElementById('admin-tab-button').classList.remove('hidden');
                    loadAdminData();
                }

                loadRewards();
                
                // Show content after everything is ready
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');

            } else {
                alert('Error fetching user data: ' + data.message);
            }
        }

        // --- [4] UI RENDERING & ACTIONS ---

        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        // Handle Check-in button click
        function handleCheckIn() {
            const btn = document.getElementById('checkin-button');
            btn.disabled = true;
            btn.textContent = 'กำลังเช็คอิน...';

            jsonpRequest({ action: 'checkIn', uid: myUid }, (data) => {
                if (data.success) {
                    alert(data.message); // Show success message
                    // Update UI immediately
                    document.getElementById('user-points').textContent = data.newPoints.toFixed(1);
                    document.getElementById('consecutive-days').textContent = data.consecutive;
                    btn.textContent = 'เช็คอินแล้ววันนี้';
                    document.getElementById('checkin-message').textContent = `คุณจะได้รับ Flex Message แจ้งเตือนในแชท`;
                    if(liff.isInClient()) {
                        liff.closeWindow();
                    }
                } else {
                    alert('Check-in failed: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'เช็คอินเลย!';
                }
            });
        }

        // Load rewards data
        function loadRewards() {
            jsonpRequest({ action: 'getRewards' }, (data) => {
                const list = document.getElementById('rewards-list');
                list.innerHTML = ''; // Clear old list
                if (data.success && data.rewards.length > 0) {
                    data.rewards.forEach(reward => {
                        list.appendChild(createRewardCard(reward));
                    });
                } else {
                    list.innerHTML = '<p class="text-gray-500 col-span-full text-center">ยังไม่มีของรางวัลในขณะนี้</p>';
                }
            });
        }

        // Create a single reward card element
        function createRewardCard(reward) {
            const canRedeem = myPoints >= reward.points;
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden';
            card.innerHTML = `
                <img src="${reward.imageUrl}" alt="${reward.name}" class="w-full h-40 object-cover">
                <div class="p-4">
                    <h3 class="font-bold text-lg">${reward.name}</h3>
                    <p class="text-gray-600 text-sm mt-1 h-10">${reward.description}</p>
                    <div class="mt-4 flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-500">ใช้คะแนน</p>
                            <p class="font-bold text-blue-600 text-xl">${reward.points}</p>
                        </div>
                        <p class="text-sm text-gray-500">คงเหลือ: ${reward.stock} ชิ้น</p>
                    </div>
                    <p class="text-xs text-red-500 mt-2">สิ้นสุด: ${reward.endDate}</p>
                    <button onclick="handleRedeem('${reward.id}')" 
                            class="mt-4 w-full font-bold py-2 px-4 rounded-lg transition ${canRedeem ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}" 
                            ${!canRedeem ? 'disabled' : ''}>
                        ${canRedeem ? 'แลกรางวัล' : 'คะแนนไม่พอ'}
                    </button>
                </div>
            `;
            return card;
        }

        // Handle Redeem button click
        function handleRedeem(rewardId) {
            if (!confirm('คุณต้องการแลกของรางวัลนี้ใช่หรือไม่?')) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'กำลังดำเนินการ...';

            jsonpRequest({ action: 'redeemReward', uid: myUid, rewardId: rewardId }, (data) => {
                if (data.success) {
                    alert(data.message);
                    myPoints = data.newPoints;
                    document.getElementById('user-points').textContent = myPoints.toFixed(1);
                    // Reload rewards to update stock and button states
                    loadRewards();
                } else {
                    alert('Redemption failed: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'แลกรางวัล';
                }
            });
        }
        
        // Load data for the admin panel
        function loadAdminData() {
            jsonpRequest({ action: 'getAdminData', uid: myUid }, (data) => {
                const list = document.getElementById('admin-list');
                list.innerHTML = '';
                if (data.success && data.pending.length > 0) {
                     data.pending.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-white p-4 rounded-lg shadow';
                        itemDiv.innerHTML = `
                            <p class="font-bold">${item.rewardName}</p>
                            <p class="text-sm text-gray-500">UID: ${item.uid}</p>
                            <p class="text-sm text-gray-500">เวลา: ${item.timestamp}</p>
                            <button onclick="handleApprove('${item.logId}', '${item.uid}', '${item.rewardName}')" class="mt-2 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition">
                                อนุมัติ
                            </button>
                        `;
                        list.appendChild(itemDiv);
                    });
                } else {
                    list.innerHTML = '<p class="text-gray-500 text-center">ไม่มีคำขอที่รอการอนุมัติ</p>';
                }
            });
        }

        // Handle Approve button click by admin
        function handleApprove(logId, targetUid, rewardName) {
            if (!confirm(`ยืนยันการอนุมัติ "${rewardName}" สำหรับผู้ใช้นี้?`)) return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'กำลังอนุมัติ...';
            
            jsonpRequest({ action: 'approveRedemption', logId: logId, targetUid: targetUid, rewardName: rewardName }, (data) => {
                if (data.success) {
                    alert(data.message);
                    loadAdminData(); // Refresh the list
                } else {
                    alert('Approval failed: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'อนุมัติ';
                }
            });
        }

    </script>
</body>
</html>
