<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ Check-in รายวัน</title>
    <link href="https://cdn.jsdelivr.net/gh/maketline/goodday/font/stylesheet.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        body { font-family: 'line_seed_sans_th', sans-serif; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .btn { background: linear-gradient(to right, #ff7e5f, #feb47b); color: white; padding: 12px 24px; border-radius: 8px; text-align: center; cursor: pointer; }
        .btn-disabled { background: #ccc; cursor: not-allowed; }
        .nav { display: flex; justify-content: space-around; background: #fff; padding: 10px; position: sticky; top: 0; z-index: 10; }
        .reward-img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <!-- Navigation -->
        <div class="nav card">
            <button class="btn" onclick="showSection('checkin')">Check-in</button>
            <button class="btn" onclick="showSection('rewards')">แลกของรางวัล</button>
            <button class="btn" id="adminBtn" style="display: none;" onclick="showSection('admin')">จัดการ (Admin)</button>
        </div>

        <!-- User Profile -->
        <div class="card" id="profileSection">
            <img id="userPicture" class="rounded-full w-16 h-16 mx-auto" src="" alt="Profile">
            <h2 id="userName" class="text-center text-xl font-bold mt-2"></h2>
            <p class="text-center text-gray-600">คะแนนสะสม: <span id="userPoints">0</span> คะแนน</p>
        </div>

        <!-- Check-in Section -->
        <div id="checkinSection" class="card">
            <h2 class="text-2xl font-bold text-center mb-4">Check-in รายวัน</h2>
            <p class="text-center text-gray-600 mb-4">Check-in ทุกวันรับ 0.5 คะแนน ครบ 7 วันรับ 1 คะแนน!</p>
            <p class="text-center text-gray-600 mb-4">สตรีคปัจจุบัน: <span id="currentStreak">0</span> วัน</p>
            <button id="checkinBtn" class="btn w-full" onclick="checkIn()">Check-in วันนี้</button>
        </div>

        <!-- Rewards Section -->
        <div id="rewardsSection" class="card" style="display: none;">
            <h2 class="text-2xl font-bold text-center mb-4">แลกของรางวัล</h2>
            <div id="rewardsList"></div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="card" style="display: none;">
            <h2 class="text-2xl font-bold text-center mb-4">จัดการการแลกของรางวัล (Admin)</h2>
            <div id="redemptionsList"></div>
        </div>
    </div>

    <script>
        let userProfile = null;
        let isAdmin = false;

        // Initialize LINE LIFF
        async function initializeLIFF() {
            try {
                await liff.init({ liffId: '1656032875-GLpZe6By' });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                document.getElementById('userPicture').src = userProfile.pictureUrl;
                document.getElementById('userName').innerText = userProfile.displayName;

                // Register user and get profile
                await jsonpRequest('registerUser', {
                    uid: userProfile.userId,
                    displayName: userProfile.displayName
                }, (response) => {
                    document.getElementById('userPoints').innerText = response.totalPoints || 0;
                    isAdmin = response.isAdmin || false;
                    if (isAdmin) {
                        document.getElementById('adminBtn').style.display = 'block';
                    }
                    loadRewards();
                    loadRedemptions();
                    loadCheckInStatus();
                });
            } catch (error) {
                console.error('LIFF Initialization failed:', error);
                alert('เกิดข้อผิดพลาดในการโหลด LINE LIFF');
            }
        }

        // JSONP Request Function
        function jsonpRequest(action, data, callback) {
            const script = document.createElement('script');
            const callbackName = 'jsonp_' + Math.round(100000 * Math.random());
            window[callbackName] = (response) => {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(response);
            };
            const url = `https://script.google.com/macros/s/AKfycbxmTQ0knrfzI2puvfueSrjlTFKjA7KzG9aj1H356zyyUAwiCrP0HxkROceSsOVSdNgPHg/exec?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}&callback=${callbackName}`;
            script.src = url;
            document.body.appendChild(script);
        }

        // Show Section
        function showSection(section) {
            document.getElementById('checkinSection').style.display = section === 'checkin' ? 'block' : 'none';
            document.getElementById('rewardsSection').style.display = section === 'rewards' ? 'block' : 'none';
            document.getElementById('adminSection').style.display = section === 'admin' && isAdmin ? 'block' : 'none';
        }

        // Check-in
        function checkIn() {
            jsonpRequest('checkIn', { uid: userProfile.userId }, (response) => {
                if (response.success) {
                    document.getElementById('userPoints').innerText = response.totalPoints;
                    document.getElementById('currentStreak').innerText = response.streak;
                    document.getElementById('checkinBtn').classList.add('btn-disabled');
                    document.getElementById('checkinBtn').disabled = true;
                    liff.sendMessages([{
                        type: 'flex',
                        altText: 'Check-in สำเร็จ',
                        contents: {
                            type: 'bubble',
                            body: {
                                type: 'box',
                                layout: 'vertical',
                                contents: [
                                    { type: 'text', text: 'Check-in สำเร็จ!', weight: 'bold', size: 'xl' },
                                    { type: 'text', text: `คุณได้รับ ${response.pointsEarned} คะแนน` },
                                    { type: 'text', text: `สตรีค: ${response.streak} วัน` },
                                    { type: 'text', text: `คะแนนรวม: ${response.totalPoints} คะแนน` }
                                ]
                            }
                        }
                    }]).then(() => {
                        alert('Check-in สำเร็จ! ตรวจสอบข้อความใน LINE');
                    });
                } else {
                    alert(response.message || 'เกิดข้อผิดพลาดในการ Check-in');
                }
            });
        }

        // Load Check-in Status
        function loadCheckInStatus() {
            jsonpRequest('getCheckInStatus', { uid: userProfile.userId }, (response) => {
                document.getElementById('currentStreak').innerText = response.streak || 0;
                if (response.hasCheckedInToday) {
                    document.getElementById('checkinBtn').classList.add('btn-disabled');
                    document.getElementById('checkinBtn').disabled = true;
                }
            });
        }

        // Load Rewards
        function loadRewards() {
            jsonpRequest('getRewards', {}, (response) => {
                const rewardsList = document.getElementById('rewardsList');
                rewardsList.innerHTML = '';
                response.rewards.forEach(reward => {
                    if (reward.stock > 0 && new Date(reward.expiryDate) >= new Date()) {
                        const rewardDiv = document.createElement('div');
                        rewardDiv.className = 'card mb-4 flex items-center';
                        rewardDiv.innerHTML = `
                            <img src="${reward.imageUrl}" class="reward-img mr-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold">${reward.name}</h3>
                                <p>คะแนนที่ใช้: ${reward.pointsRequired}</p>
                                <p>คงเหลือ: ${reward.stock}</p>
                                <p>หมดอายุ: ${new Date(reward.expiryDate).toLocaleDateString('th-TH')}</p>
                            </div>
                            <button class="btn ${userProfile.totalPoints < reward.pointsRequired ? 'btn-disabled' : ''}" 
                                    ${userProfile.totalPoints < reward.pointsRequired ? 'disabled' : ''} 
                                    onclick="redeemReward('${reward.rewardId}', ${reward.pointsRequired})">
                                แลก
                            </button>
                        `;
                        rewardsList.appendChild(rewardDiv);
                    }
                });
            });
        }

        // Redeem Reward
        function redeemReward(rewardId, pointsRequired) {
            jsonpRequest('redeemReward', { uid: userProfile.userId, rewardId, pointsRequired }, (response) => {
                if (response.success) {
                    document.getElementById('userPoints').innerText = response.newPoints;
                    userProfile.totalPoints = response.newPoints;
                    loadRewards();
                    liff.sendMessages([{
                        type: 'flex',
                        altText: 'ส่งคำขอแลกของรางวัล',
                        contents: {
                            type: 'bubble',
                            body: {
                                type: 'box',
                                layout: 'vertical',
                                contents: [
                                    { type: 'text', text: 'ส่งคำขอแลกของรางวัลสำเร็จ!', weight: 'bold', size: 'xl' },
                                    { type: 'text', text: `รางวัล: ${response.rewardName}` },
                                    { type: 'text', text: `สถานะ: รอการอนุมัติ` }
                                ]
                            }
                        }
                    }]).then(() => {
                        alert('ส่งคำขอแลกของรางวัลสำเร็จ! ตรวจสอบข้อความใน LINE');
                    });
                } else {
                    alert(response.message || 'เกิดข้อผิดพลาดในการแลกของรางวัล');
                }
            });
        }

        // Load Redemptions (Admin)
        function loadRedemptions() {
            if (!isAdmin) return;
            jsonpRequest('getRedemptions', {}, (response) => {
                const redemptionsList = document.getElementById('redemptionsList');
                redemptionsList.innerHTML = '';
                response.redemptions.forEach(redemption => {
                    if (redemption.status === 'Pending') {
                        const redemptionDiv = document.createElement('div');
                        redemptionDiv.className = 'card mb-4';
                        redemptionDiv.innerHTML = `
                            <p><strong>UID:</strong> ${redemption.uid}</p>
                            <p><strong>รางวัล:</strong> ${redemption.rewardName}</p>
                            <p><strong>เวลา:</strong> ${new Date(redemption.timestamp).toLocaleString('th-TH')}</p>
                            <button class="btn" onclick="approveRedemption('${redemption.uid}', '${redemption.rewardId}')">อนุมัติ</button>
                        `;
                        redemptionsList.appendChild(redemptionDiv);
                    }
                });
            });
        }

        // Approve Redemption (Admin)
        function approveRedemption(uid, rewardId) {
            jsonpRequest('approveRedemption', { uid, rewardId }, (response) => {
                if (response.success) {
                    loadRedemptions();
                    liff.sendMessages([{
                        type: 'flex',
                        altText: 'การแลกของรางวัลได้รับการอนุมัติ',
                        contents: {
                            type: 'bubble',
                            body: {
                                type: 'box',
                                layout: 'vertical',
                                contents: [
                                    { type: 'text', text: 'การแลกของรางวัลได้รับการอนุมัติ!', weight: 'bold', size: 'xl' },
                                    { type: 'text', text: `รางวัล: ${response.rewardName}` },
                                    { type: 'text', text: 'ขอบคุณที่เข้าร่วม!' }
                                ]
                            }
                        }
                    }]).then(() => {
                        alert('อนุมัติสำเร็จ! ผู้ใช้ได้รับแจ้งใน LINE');
                    });
                } else {
                    alert(response.message || 'เกิดข้อผิดพลาดในการอนุมัติ');
                }
            });
        }

        // Initialize
        initializeLIFF();
    </script>
</body>
</html>
