<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการบัญชีธนาคาร</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
        }
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        .page-title {
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn-animate {
            transition: all 0.3s ease;
        }
        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .page-container {
            min-height: calc(100vh - 80px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .bank-card {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #60a5fa 10%, #ffffff 20%);
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .bank-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header p-4 flex items-center space-x-4">
        <button onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="page-title">จัดการบัญชีธนาคาร</h1>
    </div>

    <!-- Main Content -->
    <div class="page-container p-4">
        <!-- Add Bank Account Button -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <button onclick="showAddBankModal()" class="w-full bg-blue-500 text-white p-3 rounded-lg font-medium hover:bg-blue-600 btn-animate">
                <i class="fas fa-plus mr-2"></i>เพิ่มบัญชีธนาคาร
            </button>
        </div>

        <!-- Bank Accounts List -->
        <div id="bankAccountsList" class="space-y-4">
            <!-- Bank accounts will be loaded here -->
        </div>
    </div>

    <!-- Bank Account Modal -->
    <div id="bankModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="bankModalTitle" class="text-lg font-bold">เพิ่มบัญชีธนาคาร</h3>
                <button onclick="closeBankModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="bankForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อธนาคาร</label>
                    <select id="bankName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">เลือกธนาคาร</option>
                        <option value="ธนาคารกรุงเทพ">ธนาคารกรุงเทพ</option>
                        <option value="ธนาคารกสิกรไทย">ธนาคารกสิกรไทย</option>
                        <option value="ธนาคารไทยพาณิชย์">ธนาคารไทยพาณิชย์</option>
                        <option value="ธนาคารกรุงไทย">ธนาคารกรุงไทย</option>
                        <option value="ธนาคารทหารไทยธนชาต">ธนาคารทหารไทยธนชาต</option>
                        <option value="ธนาคารกรุงศรีอยุธยา">ธนาคารกรุงศรีอยุธยา</option>
                    </select>
                    <p id="bankNameError" class="error-message hidden"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลขบัญชี</label>
                    <input type="text" id="accountNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="กรอกเลขบัญชี" required>
                    <p id="accountNumberError" class="error-message hidden"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อบัญชี</label>
                    <input type="text" id="accountName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="กรอกชื่อบัญชี" required>
                    <p id="accountNameError" class="error-message hidden"></p>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeBankModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg font-medium hover:bg-gray-600">
                        ยกเลิก
                    </button>
                    <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600">
                        <span id="bankSubmitText">บันทึก</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        let bankAccounts = [];
        let editingBankId = null;

        // Utility Functions
        function getBankColor(bankName) {
            const colors = {
                'ธนาคารกรุงเทพ': '#1E40AF',
                'ธนาคารกสิกรไทย': '#059669',
                'ธนาคารไทยพาณิชย์': '#7C3AED',
                'ธนาคารกรุงไทย': '#DC2626',
                'ธนาคารทหารไทยธนชาต': '#EA580C',
                'ธนาคารกรุงศรีอยุธยา': '#0891B2'
            };
            return colors[bankName] || '#6B7280';
        }

        function getBankInitial(bankName) {
            const initials = {
                'ธนาคารกรุงเทพ': 'BBL',
                'ธนาคารกสิกรไทย': 'KBANK',
                'ธนาคารไทยพาณิชย์': 'SCB',
                'ธนาคารกรุงไทย': 'KTB',
                'ธนาคารทหารไทยธนชาต': 'TTB',
                'ธนาคารกรุงศรีอยุธยา': 'BAY'
            };
            return initials[bankName] || bankName.slice(0, 3);
        }

        // Navigation Functions
        function goBack() {
            window.history.back();
        }

        // Data Loading Functions
        async function loadBankAccounts() {
            try {
                fetch(`${API_URL}?action=getBankAccounts`)
                    .then(res => res.text())
                    .then(data => {
                        const response = JSON.parse(data);
                        if (response.success) {
                            bankAccounts = response.bankAccounts || [];
                            renderBankAccounts();
                        } else {
                            throw new Error(response.message || 'ไม่สามารถโหลดบัญชีธนาคารได้');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading bank accounts:', error);
                        bankAccounts = [];
                        renderBankAccounts();
                        alert('ไม่สามารถโหลดบัญชีธนาคารได้: ' + error.message);
                    });
            } catch (error) {
                console.error('Error loading bank accounts:', error);
                alert('ไม่สามารถโหลดบัญชีธนาคารได้: ' + error.message);
            }
        }

        // Render bank accounts
        function renderBankAccounts() {
            const container = document.getElementById('bankAccountsList');
            container.innerHTML = '';
            if (bankAccounts.length === 0) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow text-center fade-in">
                        <i class="fas fa-university text-6xl text-blue-500 mb-4"></i>
                        <p class="text-gray-500">ยังไม่มีบัญชีธนาคาร</p>
                        <p class="text-gray-400 text-sm">เพิ่มบัญชีธนาคารเพื่อรับการฝากเงิน</p>
                    </div>
                `;
                return;
            }
            bankAccounts.forEach((account, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-4 card-hover fade-in bank-card';

                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="bank-icon" style="background-color: ${getBankColor(account.bankName)}">
                                ${getBankInitial(account.bankName)}
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${account.bankName}</h4>
                                <p class="text-sm text-gray-600">เลขบัญชี: ${account.accountNumber}</p>
                                <p class="text-sm text-gray-600">ชื่อบัญชี: ${account.accountName}</p>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="editBankAccount(${index})"
                                    class="bg-orange-500 text-white px-3 py-1 rounded text-xs hover:bg-orange-600 btn-animate">
                                <i class="fas fa-edit mr-1"></i>แก้ไข
                            </button>
                            <button onclick="deleteBankAccount(${index})"
                                    class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 btn-animate">
                                <i class="fas fa-trash mr-1"></i>ลบ
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Bank Account Management Functions
        function showAddBankModal() {
            editingBankId = null;
            document.getElementById('bankModalTitle').textContent = 'เพิ่มบัญชีธนาคาร';
            document.getElementById('bankSubmitText').textContent = 'บันทึก';
            document.getElementById('bankForm').reset();
            clearFormErrors();
            document.getElementById('bankModal').classList.remove('hidden');
        }

        function editBankAccount(index) {
            const account = bankAccounts[index];
            editingBankId = index;

            document.getElementById('bankModalTitle').textContent = 'แก้ไขบัญชีธนาคาร';
            document.getElementById('bankSubmitText').textContent = 'อัพเดท';
            document.getElementById('bankName').value = account.bankName;
            document.getElementById('accountNumber').value = account.accountNumber;
            document.getElementById('accountName').value = account.accountName;
            clearFormErrors();
            document.getElementById('bankModal').classList.remove('hidden');
        }

        function closeBankModal() {
            document.getElementById('bankModal').classList.add('hidden');
            editingBankId = null;
            clearFormErrors();
        }

        function clearFormErrors() {
            ['bankName', 'accountNumber', 'accountName'].forEach(field => {
                const input = document.getElementById(field);
                const error = document.getElementById(field + 'Error');
                input.classList.remove('input-error');
                error.classList.add('hidden');
                error.textContent = '';
            });
        }

        function showFormError(field, message) {
            const input = document.getElementById(field);
            const error = document.getElementById(field + 'Error');
            input.classList.add('input-error');
            error.textContent = message;
            error.classList.remove('hidden');
        }

        async function deleteBankAccount(index) {
            const account = bankAccounts[index];

            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                html: `คุณต้องการลบบัญชีธนาคาร<br><strong>${account.bankName}</strong><br>เลขบัญชี: <strong>${account.accountNumber}</strong><br>ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#ef4444'
            });

            if (result.isConfirmed) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'deleteBankAccount');
                    formData.append('bankName', account.bankName);
                    formData.append('accountNumber', account.accountNumber);

                    fetch(API_URL, {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.text())
                    .then(data => {
                        const response = JSON.parse(data);
                        if (response.success) {
                            Swal.fire('สำเร็จ!', 'ลบบัญชีธนาคารเรียบร้อยแล้ว', 'success');
                            loadBankAccounts();
                        } else {
                            throw new Error(response.message || 'ไม่สามารถลบบัญชีธนาคารได้');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting bank account:', error);
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถลบบัญชีธนาคารได้: ' + error.message, 'error');
                    });
                } catch (error) {
                    console.error('Error deleting bank account:', error);
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถลบบัญชีธนาคารได้: ' + error.message, 'error');
                }
            }
        }

        // Handle bank form submission
        document.getElementById('bankForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const bankName = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const accountName = document.getElementById('accountName').value.trim();

            // Client-side validation
            clearFormErrors();
            let hasError = false;
            if (!bankName) {
                showFormError('bankName', 'กรุณาเลือกธนาคาร');
                hasError = true;
            }
            if (!/^\d{10,15}$/.test(accountNumber)) {
                showFormError('accountNumber', 'เลขบัญชีต้องเป็นตัวเลข 10-15 หลัก');
                hasError = true;
            }
            if (!accountName || accountName.length < 2) {
                showFormError('accountName', 'กรุณากรอกชื่อบัญชี (อย่างน้อย 2 ตัวอักษร)');
                hasError = true;
            }

            if (!hasError && editingBankId === null) {
                const duplicate = bankAccounts.find(account =>
                    account.bankName === bankName && account.accountNumber === accountNumber
                );
                if (duplicate) {
                    showFormError('accountNumber', 'เลขบัญชีนี้มีอยู่ในระบบแล้ว');
                    hasError = true;
                }
            }

            if (hasError) return;

            try {
                const formData = new FormData();
                formData.append('action', editingBankId !== null ? 'updateBankAccount' : 'addBankAccount');
                formData.append('bankName', bankName);
                formData.append('accountNumber', accountNumber);
                formData.append('accountName', accountName);

                if (editingBankId !== null) {
                    const oldAccount = bankAccounts[editingBankId];
                    formData.append('oldBankName', oldAccount.bankName);
                    formData.append('oldAccountNumber', oldAccount.accountNumber);
                }

                fetch(API_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.text())
                .then(data => {
                    const response = JSON.parse(data);
                    if (response.success) {
                        Swal.fire('สำเร็จ!', editingBankId !== null ? 'อัพเดทบัญชีธนาคารเรียบร้อยแล้ว' : 'เพิ่มบัญชีธนาคารเรียบร้อยแล้ว', 'success');
                        closeBankModal();
                        loadBankAccounts();
                    } else {
                        throw new Error(response.message || 'ไม่สามารถดำเนินการได้');
                    }
                })
                .catch(error => {
                    console.error('Error saving bank account:', error);
                    Swal.fire('ข้อผิดพลาด', error.message || 'ไม่สามารถบันทึกบัญชีธนาคารได้', 'error');
                });
            } catch (error) {
                console.error('Error saving bank account:', error);
                Swal.fire('ข้อผิดพลาด', error.message || 'ไม่สามารถบันทึกบัญชีธนาคารได้', 'error');
            }
        });

        // Initialize App
        document.addEventListener('DOMContentLoaded', loadBankAccounts);
    </script>
</body>
</html>
