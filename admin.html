<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการระบบ - ระบบออมทอง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
        }
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        .page-title {
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn-animate {
            transition: all 0.3s ease;
        }
        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .page-container {
            min-height: calc(100vh - 80px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .bank-card {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #60a5fa 10%, #ffffff 20%);
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom: 2px solid;
            font-weight: 600;
        }
        .bank-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header p-4 flex items-center space-x-4">
        <button onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="page-title">จัดการบัญชีธนาคาร</h1>
        <div class="flex space-x-2">
            <button onclick="toggleLogs()" class="back-btn" title="แสดง/ซ่อน Logs">
                <i class="fas fa-terminal"></i>
            </button>
            <button onclick="refreshBankAccounts()" class="back-btn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Log Panel (Hidden by default) -->
    <div id="logPanel" class="hidden bg-white shadow-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-sm">System Logs</h3>
            <button onclick="clearLogs()" class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">
                Clear
            </button>
        </div>
        <div id="logContainer" class="log-container">
            <div class="info">[SYSTEM] System initialized</div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="page-container p-4">
        <!-- Add Bank Account Button -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <button onclick="showAddBankModal()" class="w-full bg-blue-500 text-white p-3 rounded-lg font-medium hover:bg-blue-600 btn-animate">
                <i class="fas fa-plus mr-2"></i>เพิ่มบัญชีธนาคาร
            </button>
        </div>
        
        <!-- Bank Accounts List -->
        <div id="bankAccountsList">
            <!-- Bank accounts will be loaded here -->
        </div>
    </div>

    <!-- Bank Account Modal -->
    <div id="bankModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="bankModalTitle" class="text-lg font-bold">เพิ่มบัญชีธนาคาร</h3>
                <button onclick="closeBankModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="bankForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อธนาคาร</label>
                    <select id="bankName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">เลือกธนาคาร</option>
                        <option value="ธนาคารกรุงเทพ">ธนาคารกรุงเทพ</option>
                        <option value="ธนาคารกสิกรไทย">ธนาคารกสิกรไทย</option>
                        <option value="ธนาคารไทยพาณิชย์">ธนาคารไทยพาณิชย์</option>
                        <option value="ธนาคารกรุงไทย">ธนาคารกรุงไทย</option>
                        <option value="ธนาคารทหารไทยธนชาต">ธนาคารทหารไทยธนชาต</option>
                        <option value="ธนาคารกรุงศรีอยุธยา">ธนาคารกรุงศรีอยุธยา</option>
                        <option value="ธนาคารเกียรตินาคินภัทร">ธนาคารเกียรตินาคินภัทร</option>
                        <option value="ธนาคารซีไอเอ็มบี ไทย">ธนาคารซีไอเอ็มบี ไทย</option>
                        <option value="ธนาคารยูโอบี">ธนาคารยูโอบี</option>
                        <option value="ธนาคารแลนด์ แอนด์ เฮ้าส์">ธนาคารแลนด์ แอนด์ เฮ้าส์</option>
                        <option value="ธนาคารไอซีบีซี">ธนาคารไอซีบีซี</option>
                        <option value="ธนาคารพันธสิน">ธนาคารพันธสิน</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลขบัญชี</label>
                    <input type="text" id="accountNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="กรอกเลขบัญชี" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อบัญชี</label>
                    <input type="text" id="accountName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="กรอกชื่อบัญชี" required>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeBankModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg font-medium hover:bg-gray-600">
                        ยกเลิก
                    </button>
                    <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600">
                        <span id="bankSubmitText">บันทึก</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ตั้งค่า API URL และ LIFF ID
        const API_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; // เปลี่ยนเป็น URL ของ Google Apps Script
        const LIFF_ID = 'YOUR_LIFF_ID_HERE'; // เปลี่ยนเป็น LIFF ID ของคุณ

        // Variables
        let bankAccounts = [];
        let editingBankId = null;

        // Simple Logging System
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 50 logs
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function toggleLogs() {
            const panel = document.getElementById('logPanel');
            panel.classList.toggle('hidden');
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="info">[SYSTEM] Logs cleared</div>';
        }

        // Bank utility functions
        function getBankColor(bankName) {
            const colors = {
                'ธนาคารกรุงเทพ': '#1E40AF',
                'ธนาคารกสิกรไทย': '#059669',
                'ธนาคารไทยพาณิชย์': '#7C3AED',
                'ธนาคารกรุงไทย': '#DC2626',
                'ธนาคารทหารไทยธนชาต': '#EA580C',
                'ธนาคารกรุงศรีอยุธยา': '#0891B2',
                'ธนาคารเกียรตินาคินภัทร': '#BE185D',
                'ธนาคารซีไอเอ็มบี ไทย': '#7C2D12',
                'ธนาคารยูโอบี': '#0C4A6E',
                'ธนาคารแลนด์ แอนด์ เฮ้าส์': '#365314',
                'ธนาคารไอซีบีซี': '#DC2626',
                'ธนาคารพันธสิน': '#1F2937'
            };
            return colors[bankName] || '#6B7280';
        }

        function getBankInitial(bankName) {
            const initials = {
                'ธนาคารกรุงเทพ': 'BBL',
                'ธนาคารกสิกรไทย': 'KBANK',
                'ธนาคารไทยพาณิชย์': 'SCB',
                'ธนาคารกรุงไทย': 'KTB',
                'ธนาคารทหารไทยธนชาต': 'TTB',
                'ธนาคารกรุงศรีอยุธยา': 'BAY',
                'ธนาคารเกียรตินาคินภัทร': 'KKP',
                'ธนาคารซีไอเอ็มบี ไทย': 'CIMB',
                'ธนาคารยูโอบี': 'UOB',
                'ธนาคารแลนด์ แอนด์ เฮ้าส์': 'LH',
                'ธนาคารไอซีบีซี': 'ICBC',
                'ธนาคารพันธสิน': 'PAN'
            };
            return initials[bankName] || bankName.substring(0, 3);
        }

        // Navigation
        function goBack() {
            window.history.back();
        }

        // 1. โหลดบัญชีธนาคาร
        async function loadBankAccounts() {
            try {
                log('กำลังโหลดบัญชีธนาคาร...', 'info');

                // ถ้ายังไม่ได้ตั้งค่า API URL ให้ใช้ข้อมูลตัวอย่าง
                if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    log('ยังไม่ได้ตั้งค่า API URL - ใช้ข้อมูลตัวอย่าง', 'warning');
                    bankAccounts = [
                        {
                            bankName: 'ธนาคารกรุงเทพ',
                            accountNumber: '1234567890',
                            accountName: 'บริษัทตัวอย่าง จำกัด',
                            createdDate: new Date().toLocaleDateString('th-TH')
                        },
                        {
                            bankName: 'ธนาคารกสิกรไทย',
                            accountNumber: '9876543210',
                            accountName: 'บริษัทตัวอย่าง จำกัด',
                            createdDate: new Date().toLocaleDateString('th-TH')
                        }
                    ];
                    renderBankAccounts();
                    return;
                }

                const response = await fetch(`${API_URL}?action=getBankAccounts&t=${Date.now()}`);
                log(`Response status: ${response.status}`, 'info');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                log(`Response length: ${text.length} characters`, 'info');

                if (!text.trim()) {
                    throw new Error('Empty response from server');
                }

                const data = JSON.parse(text);
                
                if (data.success) {
                    bankAccounts = data.bankAccounts || [];
                    log(`โหลดบัญชีธนาคารสำเร็จ: ${bankAccounts.length} บัญชี`, 'success');
                } else {
                    throw new Error(data.message || 'Failed to load bank accounts');
                }

            } catch (error) {
                log(`Error loading bank accounts: ${error.message}`, 'error');
                // ใช้ข้อมูลเปล่าถ้าโหลดไม่ได้
                bankAccounts = [];
            }

            renderBankAccounts();
        }

        // 2. แสดงบัญชีธนาคาร
        function renderBankAccounts() {
            const container = document.getElementById('bankAccountsList');
            
            if (bankAccounts.length === 0) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow text-center fade-in">
                        <i class="fas fa-university text-6xl text-blue-500 mb-4"></i>
                        <p class="text-gray-500">ยังไม่มีบัญชีธนาคาร</p>
                        <p class="text-gray-400 text-sm">เพิ่มบัญชีธนาคารเพื่อรับการฝากเงิน</p>
                    </div>
                `;
                return;
            }

            let html = '';
            bankAccounts.forEach((account, index) => {
                html += `
                    <div class="bg-white rounded-lg shadow p-4 mb-4 card-hover fade-in bank-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bank-icon" style="background-color: ${getBankColor(account.bankName)}">
                                    ${getBankInitial(account.bankName)}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${account.bankName}</h4>
                                    <p class="text-sm text-gray-600">เลขบัญชี: ${account.accountNumber}</p>
                                    <p class="text-sm text-gray-600">ชื่อบัญชี: ${account.accountName}</p>
                                    <p class="text-xs text-gray-500">สร้างเมื่อ: ${account.createdDate || 'ไม่ระบุ'}</p>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button onclick="editBankAccount(${index})" 
                                        class="bg-orange-500 text-white px-3 py-1 rounded text-xs hover:bg-orange-600 btn-animate">
                                    <i class="fas fa-edit mr-1"></i>แก้ไข
                                </button>
                                <button onclick="deleteBankAccount(${index})" 
                                        class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 btn-animate">
                                    <i class="fas fa-trash mr-1"></i>ลบ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            log(`แสดงบัญชีธนาคาร: ${bankAccounts.length} บัญชี`, 'success');
        }

        // 3. เพิ่มบัญชีธนาคาร
        function showAddBankModal() {
            log('เปิด Modal เพิ่มบัญชีธนาคาร', 'info');
            editingBankId = null;
            document.getElementById('bankModalTitle').textContent = 'เพิ่มบัญชีธนาคาร';
            document.getElementById('bankSubmitText').textContent = 'บันทึก';
            document.getElementById('bankForm').reset();
            document.getElementById('bankModal').classList.remove('hidden');
        }

        // 4. แก้ไขบัญชีธนาคาร
        function editBankAccount(index) {
            if (!bankAccounts[index]) {
                log(`ไม่พบบัญชีธนาคาร index: ${index}`, 'error');
                return;
            }

            const account = bankAccounts[index];
            log(`แก้ไขบัญชีธนาคาร: ${account.bankName} - ${account.accountNumber}`, 'info');
            
            editingBankId = index;
            document.getElementById('bankModalTitle').textContent = 'แก้ไขบัญชีธนาคาร';
            document.getElementById('bankSubmitText').textContent = 'อัพเดท';
            document.getElementById('bankName').value = account.bankName;
            document.getElementById('accountNumber').value = account.accountNumber;
            document.getElementById('accountName').value = account.accountName;
            document.getElementById('bankModal').classList.remove('hidden');
        }

        // 5. ลบบัญชีธนาคาร
        async function deleteBankAccount(index) {
            if (!bankAccounts[index]) {
                log(`ไม่พบบัญชีธนาคาร index: ${index}`, 'error');
                return;
            }

            const account = bankAccounts[index];
            
            // ยืนยันการลบ
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                html: `คุณต้องการลบบัญชีธนาคาร<br><strong>${account.bankName}</strong><br>เลขบัญชี: <strong>${account.accountNumber}</strong><br>ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#ef4444'
            });

            if (!result.isConfirmed) return;

            try {
                log(`กำลังลบบัญชีธนาคาร: ${account.bankName} - ${account.accountNumber}`, 'info');

                // ถ้ายังไม่ได้ตั้งค่า API URL ให้ลบจาก array
                if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    bankAccounts.splice(index, 1);
                    renderBankAccounts();
                    log('ลบบัญชีธนาคารสำเร็จ (Demo Mode)', 'success');
                    Swal.fire('สำเร็จ!', 'ลบบัญชีธนาคารเรียบร้อยแล้ว (Demo Mode)', 'success');
                    return;
                }

                // Loading
                Swal.fire({
                    title: 'กำลังลบ...',
                    text: 'กรุณารอสักครู่',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => Swal.showLoading()
                });

                // ส่งข้อมูลไปลบ
                const formData = new FormData();
                formData.append('action', 'deleteBankAccount');
                formData.append('bankName', account.bankName);
                formData.append('accountNumber', account.accountNumber);
                formData.append('accountName', account.accountName);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                log(`Delete response: ${text}`, 'info');

                // ตรวจสอบผลลัพธ์
                let success = false;
                try {
                    const data = JSON.parse(text);
                    success = data.success;
                } catch (e) {
                    // ถ้า parse JSON ไม่ได้ ตรวจสอบจาก text
                    success = text.includes('success') || text.includes('สำเร็จ') || text.includes('deleted');
                }

                if (success) {
                    log('ลบบัญชีธนาคารสำเร็จ', 'success');
                    Swal.fire('สำเร็จ!', 'ลบบัญชีธนาคารเรียบร้อยแล้ว', 'success');
                    await loadBankAccounts();
                } else {
                    throw new Error('ไม่สามารถลบบัญชีธนาคารได้');
                }

            } catch (error) {
                log(`Error deleting bank account: ${error.message}`, 'error');
                Swal.fire('ข้อผิดพลาด', error.message, 'error');
            }
        }

        // 6. ปิด Modal
        function closeBankModal() {
            log('ปิด Modal บัญชีธนาคาร', 'info');
            document.getElementById('bankModal').classList.add('hidden');
            editingBankId = null;
        }

        // 7. Refresh ข้อมูล
        async function refreshBankAccounts() {
            log('รีเฟรชข้อมูลบัญชีธนาคาร', 'info');
            
            const refreshBtn = event.target;
            const originalIcon = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshBtn.disabled = true;

            try {
                await loadBankAccounts();
                Swal.fire({
                    icon: 'success',
                    title: 'รีเฟรชเรียบร้อย',
                    timer: 1500,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            } catch (error) {
                log(`Error refreshing: ${error.message}`, 'error');
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถรีเฟรชข้อมูลได้', 'error');
            } finally {
                refreshBtn.innerHTML = originalIcon;
                refreshBtn.disabled = false;
            }
        }

        // 8. จัดการ Form Submit
        document.getElementById('bankForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bankName = document.getElementById('bankName').value.trim();
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const accountName = document.getElementById('accountName').value.trim();

            // ตรวจสอบข้อมูล
            if (!bankName || !accountNumber || !accountName) {
                log('ข้อมูลไม่ครบถ้วน', 'error');
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            // ตรวจสอบเลขบัญชี
            if (!/^\d{10,15}$/.test(accountNumber)) {
                log('เลขบัญชีไม่ถูกต้อง', 'error');
                Swal.fire('ข้อผิดพลาด', 'เลขบัญชีต้องเป็นตัวเลข 10-15 หลัก', 'error');
                return;
            }

            const isEdit = editingBankId !== null;
            log(`${isEdit ? 'แก้ไข' : 'เพิ่ม'}บัญชีธนาคาร: ${bankName} - ${accountNumber}`, 'info');

            try {
                // ถ้ายังไม่ได้ตั้งค่า API URL 
                if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    const newAccount = {
                        bankName,
                        accountNumber,
                        accountName,
                        createdDate: new Date().toLocaleDateString('th-TH')
                    };
                    
                    if (isEdit) {
                        bankAccounts[editingBankId] = newAccount;
                        log('แก้ไขบัญชีธนาคารสำเร็จ (Demo Mode)', 'success');
                    } else {
                        bankAccounts.push(newAccount);
                        log('เพิ่มบัญชีธนาคารสำเร็จ (Demo Mode)', 'success');
                    }
                    
                    Swal.fire('สำเร็จ!', `${isEdit ? 'แก้ไข' : 'เพิ่ม'}บัญชีธนาคารเรียบร้อยแล้ว (Demo Mode)`, 'success');
                    closeBankModal();
                    renderBankAccounts();
                    return;
                }

                // Loading
                Swal.fire({
                    title: `${isEdit ? 'กำลังแก้ไข...' : 'กำลังบันทึก...'}`,
                    text: 'กรุณารอสักครู่',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => Swal.showLoading()
                });

                // เตรียมข้อมูลส่ง
                const formData = new FormData();
                formData.append('action', isEdit ? 'updateBankAccount' : 'addBankAccount');
                formData.append('bankName', bankName);
                formData.append('accountNumber', accountNumber);
                formData.append('accountName', accountName);
                
                // ถ้าเป็นการแก้ไข ส่งข้อมูลเก่าด้วย
                if (isEdit) {
                    const oldAccount = bankAccounts[editingBankId];
                    formData.append('oldBankName', oldAccount.bankName);
                    formData.append('oldAccountNumber', oldAccount.accountNumber);
                    formData.append('oldAccountName', oldAccount.accountName);
                }

                // ส่งข้อมูล
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                log(`${isEdit ? 'Update' : 'Add'} response: ${text}`, 'info');

                // ตรวจสอบผลลัพธ์
                let success = false;
                try {
                    const data = JSON.parse(text);
                    success = data.success;
                } catch (e) {
                    // ถ้า parse JSON ไม่ได้ ตรวจสอบจาก text
                    success = text.includes('success') || text.includes('สำเร็จ') || 
                             text.includes('added') || text.includes('updated');
                }

                if (success) {
                    log(`${isEdit ? 'แก้ไข' : 'เพิ่ม'}บัญชีธนาคารสำเร็จ`, 'success');
                    Swal.fire('สำเร็จ!', `${isEdit ? 'แก้ไข' : 'เพิ่ม'}บัญชีธนาคารเรียบร้อยแล้ว`, 'success');
                    closeBankModal();
                    await loadBankAccounts();
                } else {
                    throw new Error(`ไม่สามารถ${isEdit ? 'แก้ไข' : 'เพิ่ม'}บัญชีธนาคารได้`);
                }

            } catch (error) {
                log(`Error saving bank account: ${error.message}`, 'error');
                Swal.fire('ข้อผิดพลาด', error.message, 'error');
            }
        });

        // 9. ฟังก์ชันทดสอบ API (สำหรับ Debug)
        window.testAPI = function() {
            log('=== ทดสอบ API ===', 'info');
            
            if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                Swal.fire({
                    icon: 'warning',
                    title: 'ยังไม่ได้ตั้งค่า API',
                    text: 'กรุณาแก้ไข API_URL ในโค้ดก่อนทดสอบ',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            // ทดสอบ GET
            log('ทดสอบ GET request...', 'info');
            fetch(`${API_URL}?action=getBankAccounts&test=true`)
                .then(response => {
                    log(`GET response status: ${response.status}`, response.ok ? 'success' : 'error');
                    return response.text();
                })
                .then(text => {
                    log(`GET response: ${text.substring(0, 100)}...`, 'info');
                    
                    try {
                        const data = JSON.parse(text);
                        const success = data.success;
                        log(`GET test result: ${success ? 'สำเร็จ' : 'ล้มเหลว'}`, success ? 'success' : 'error');
                        
                        Swal.fire({
                            icon: success ? 'success' : 'error',
                            title: 'ผลการทดสอบ GET',
                            text: success ? 'API ทำงานปกติ' : 'API มีปัญหา',
                            confirmButtonText: 'ตกลง'
                        });
                    } catch (e) {
                        log(`GET JSON parse error: ${e.message}`, 'error');
                        Swal.fire('Error', 'Response ไม่ใช่ JSON ที่ถูกต้อง', 'error');
                    }
                })
                .catch(error => {
                    log(`GET test failed: ${error.message}`, 'error');
                    Swal.fire('Error', `ทดสอบ API ล้มเหลว: ${error.message}`, 'error');
                });
        };

        // 10. เริ่มต้นระบบ
        async function init() {
            try {
                log('เริ่มต้นระบบ...', 'info');
                
                // ตรวจสอบ API URL
                if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    log('⚠️ ยังไม่ได้ตั้งค่า API_URL', 'warning');
                    Swal.fire({
                        icon: 'info',
                        title: 'โหมดทดสอบ',
                        text: 'ระบบกำลังทำงานในโหมดทดสอบ กรุณาตั้งค่า API_URL เพื่อเชื่อมต่อกับ Google Sheets',
                        confirmButtonText: 'เข้าใจแล้ว'
                    });
                }

                // โหลดข้อมูลบัญชีธนาคาร
                await loadBankAccounts();
                
                log('เริ่มต้นระบบเสร็จสิ้น', 'success');

            } catch (error) {
                log(`Error during initialization: ${error.message}`, 'error');
            }
        }

        // เริ่มต้นเมื่อหน้าเว็บโหลดเสร็จ
        window.addEventListener('load', init);

        // เพิ่มฟังก์ชันใน console สำหรับ debug
        window.showBankAccounts = () => {
            console.table(bankAccounts);
            log(`Current bank accounts: ${bankAccounts.length} accounts`, 'info');
        };

        window.addSampleBank = () => {
            const sampleBank = {
                bankName: 'ธนาคารกรุงเทพ',
                accountNumber: '1234567890',
                accountName: 'บริษัทตัวอย่าง จำกัด',
                createdDate: new Date().toLocaleDateString('th-TH')
            };
            bankAccounts.push(sampleBank);
            renderBankAccounts();
            log('เพิ่มบัญชีตัวอย่างแล้ว', 'success');
        };
    </script>
</body>
</html>
